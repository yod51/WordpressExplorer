<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WordPress Media Explorer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      color: #1e1e1e;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #23282d;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    input,
    select,
    button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #2271b1;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #135e96;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .media-item {
      background-color: #fff;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .media-preview {
      height: 150px;
      background-color: #f1f1f1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .media-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .media-info {
      padding: 10px;
      font-size: 14px;
    }

    .media-title {
      margin: 0 0 5px 0;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-meta {
      color: #666;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .media-actions {
      margin-top: 10px;
      display: flex;
      gap: 5px;
    }

    .media-actions button {
      flex: 1;
      font-size: 12px;
      padding: 5px;
    }

    .list-view {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .list-view th,
    .list-view td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #f1f1f1;
    }

    .list-view th {
      background-color: #f9f9f9;
      font-weight: 600;
      color: #23282d;
      cursor: pointer;
    }

    .list-view th:hover {
      background-color: #f1f1f1;
    }

    .list-view tr:hover {
      background-color: #f9f9f9;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 10px;
    }

    .page-info {
      display: flex;
      align-items: center;
      margin-right: auto;
      font-size: 14px;
      color: #555;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #2271b1;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .view-toggle {
      display: flex;
      gap: 5px;
    }

    .view-toggle button {
      padding: 5px 10px;
    }

    .active-view {
      background-color: #135e96;
    }

    .hidden {
      display: none;
    }

    #error-message {
      color: #d63638;
      background-color: #ffecec;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }

    .file-icon {
      font-size: 48px;
      color: #2271b1;
    }

    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .preview-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .preview-content img,
    .preview-content video,
    .preview-content audio {
      max-width: 100%;
      max-height: 90vh;
      background-color: #fff;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .close-preview {
      position: absolute;
      top: -40px;
      right: 0;
      background-color: transparent;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    .proxy-note {
      margin-top: 10px;
      padding: 10px;
      background-color: #fff8e5;
      border-left: 4px solid #ffb900;
      margin-bottom: 20px;
    }

    #proxy-selector {
      margin-left: 10px;
    }

    .list-preview {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      overflow: hidden;
      background-color: #f1f1f1;
    }

    .list-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .list-view td:first-child {
      display: flex;
      align-items: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>WordPress Media Explorer</h1>
      <div id="error-message"></div>

      <div class="controls">
        <div class="input-group">
          <input type="text" id="site-url" placeholder="WordPress Site URL" />
          <select id="proxy-selector">
            <option value="allorigins">All Origins Proxy</option>
            <option value="cors-anywhere">CORS Anywhere Proxy</option>
            <option value="noproxy">No Proxy (Direct)</option>
          </select>
          <button id="connect-btn">Connect</button>
        </div>

        <div class="input-group" id="search-controls" style="display: none;">
          <input type="text" id="search-input" placeholder="Search media..." />
          <select id="media-type">
            <option value="">All Types</option>
            <option value="image">Images</option>
            <option value="video">Videos</option>
            <option value="audio">Audio</option>
            <option value="application">Documents</option>
          </select>
          <select id="sort-by">
            <option value="date">Date</option>
            <option value="title">Title</option>
            <option value="id">ID</option>
          </select>
          <select id="sort-order">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
          </select>
          <label for="per-page">Items per page:</label>
          <input type="number" id="per-page" min="1" max="100" value="10" style="width: 60px;">
          <div class="view-toggle">
            <button id="grid-view-btn" class="active-view">Grid</button>
            <button id="list-view-btn">List</button>
          </div>
        </div>
      </div>

      <div class="proxy-note">
        <strong>Note:</strong> If you're experiencing CORS errors, try using a different proxy or select "No Proxy" if
        the WordPress site allows direct access.
      </div>
    </header>

    <div id="loader" class="loader"></div>
    <div id="page-info" class="page-info"></div>

    <div id="media-grid" class="media-grid"></div>
    <table id="media-list" class="list-view" style="display: none;">
      <thead>
        <tr>
          <th width="40%">Title</th>
          <th width="15%">Type</th>
          <th width="15%">Date</th>
          <th width="10%">Size</th>
          <th width="20%">Actions</th>
        </tr>
      </thead>
      <tbody id="list-body"></tbody>
    </table>

    <div class="pagination">
      <button id="prev-page" disabled>← Previous</button>
      <button id="next-page" disabled>Next →</button>
    </div>

    <div id="preview-modal" class="preview-modal">
      <div class="preview-content">
        <button class="close-preview">&times;</button>
        <div id="preview-container"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // State
      const state = {
        siteUrl: '',
        mediaItems: [],
        totalItems: 0,
        totalPages: 0,
        currentPage: 1,
        perPage: 10, // Changed default to 10
        search: '',
        mediaType: '',
        sortBy: 'date',
        sortOrder: 'desc',
        viewMode: 'grid',
        isLoading: false,
        proxyType: 'allorigins' // Changed default to allorigins
      };

      // Proxy URLs
      const PROXY_URLS = {
        'cors-anywhere': 'https://cors-anywhere.herokuapp.com/',
        'allorigins': 'https://api.allorigins.win/raw?url='
      };

      // Elements
      const siteUrlInput = document.getElementById('site-url');
      const proxySelector = document.getElementById('proxy-selector');
      const connectBtn = document.getElementById('connect-btn');
      const searchControls = document.getElementById('search-controls');
      const searchInput = document.getElementById('search-input');
      const mediaTypeSelect = document.getElementById('media-type');
      const sortBySelect = document.getElementById('sort-by');
      const sortOrderSelect = document.getElementById('sort-order');
      const perPageInput = document.getElementById('per-page');
      const mediaGrid = document.getElementById('media-grid');
      const mediaList = document.getElementById('media-list');
      const listBody = document.getElementById('list-body');
      const prevPageBtn = document.getElementById('prev-page');
      const nextPageBtn = document.getElementById('next-page');
      const gridViewBtn = document.getElementById('grid-view-btn');
      const listViewBtn = document.getElementById('list-view-btn');
      const loader = document.getElementById('loader');
      const pageInfo = document.getElementById('page-info');
      const errorMessage = document.getElementById('error-message');
      const previewModal = document.getElementById('preview-modal');
      const previewContainer = document.getElementById('preview-container');
      const closePreview = document.querySelector('.close-preview');

      // Event Listeners
      connectBtn.addEventListener('click', connectToSite);
      proxySelector.addEventListener('change', updateProxyType);
      searchInput.addEventListener('input', debounce(updateSearch, 500));
      mediaTypeSelect.addEventListener('change', updateFilters);
      sortBySelect.addEventListener('change', updateFilters);
      sortOrderSelect.addEventListener('change', updateFilters);
      perPageInput.addEventListener('change', updatePerPage);
      prevPageBtn.addEventListener('click', goToPreviousPage);
      nextPageBtn.addEventListener('click', goToNextPage);
      gridViewBtn.addEventListener('click', () => switchView('grid'));
      listViewBtn.addEventListener('click', () => switchView('list'));
      closePreview.addEventListener('click', closePreviewModal);

      // Update proxy type
      function updateProxyType() {
        state.proxyType = proxySelector.value;
      }

      // Update per page
      function updatePerPage() {
        const value = parseInt(perPageInput.value);
        if (value > 0 && value <= 100) {
          state.perPage = value;
          state.currentPage = 1;
          fetchMedia();
        } else {
          // Reset to valid range if outside bounds
          perPageInput.value = state.perPage;
        }
      }

      // Get proxied URL
      function getProxiedUrl(url) {
        if (state.proxyType === 'noproxy') {
          return url;
        } else if (state.proxyType === 'allorigins') {
          return PROXY_URLS.allorigins + encodeURIComponent(url);
        } else {
          return PROXY_URLS['cors-anywhere'] + url;
        }
      }

      // Connect to WordPress site
      function connectToSite() {
        let url = siteUrlInput.value.trim();
        if (!url) {
          showError('Please enter a WordPress site URL');
          return;
        }

        // Add protocol if missing
        if (!/^https?:\/\//i.test(url)) {
          url = 'https://' + url;
        }

        state.siteUrl = url.endsWith('/') ? url.slice(0, -1) : url;
        state.currentPage = 1;
        fetchMedia();
        searchControls.style.display = 'flex';
      }

      // Fetch media from WordPress REST API
      function fetchMedia() {
        setLoading(true);
        hideError();

        // Build API URL
        let apiUrl = `${state.siteUrl}/wp-json/wp/v2/media?per_page=${state.perPage}&page=${state.currentPage}`;

        // Add search params
        if (state.search) {
          apiUrl += `&search=${encodeURIComponent(state.search)}`;
        }

        // Add media type filter
        if (state.mediaType) {
          apiUrl += `&media_type=${encodeURIComponent(state.mediaType)}`;
        }

        // Add sorting
        apiUrl += `&orderby=${state.sortBy}&order=${state.sortOrder}`;

        // Apply proxy if needed
        const fetchUrl = getProxiedUrl(apiUrl);

        // Options for fetch
        const fetchOptions = {};
        if (state.proxyType === 'cors-anywhere') {
          fetchOptions.headers = {
            'X-Requested-With': 'XMLHttpRequest'
          };
        }

        // Fetch data
        fetch(fetchUrl, fetchOptions)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            // Get total values from headers
            let totalItems = 0;
            let totalPages = 0;

            // Try to get pagination headers
            const wpTotal = response.headers.get('X-WP-Total');
            const wpTotalPages = response.headers.get('X-WP-TotalPages');

            if (wpTotal && wpTotalPages) {
              totalItems = parseInt(wpTotal);
              totalPages = parseInt(wpTotalPages);
            }

            state.totalItems = totalItems;
            state.totalPages = totalPages;

            return response.json();
          })
          .then(data => {
            if (!Array.isArray(data)) {
              throw new Error('Invalid response format. Expected an array of media items.');
            }

            state.mediaItems = data;

            // If we couldn't get pagination info from headers, estimate it
            if (state.totalItems === 0 && data.length > 0) {
              state.totalItems = data.length * 10; // Rough estimate
              state.totalPages = 10; // Rough estimate
            }

            renderMedia();
            updatePagination();
            setLoading(false);
          })
          .catch(error => {
            console.error('Fetch error:', error);
            showError(`Failed to fetch media: ${error.message}. Try a different proxy or check the URL.`);
            setLoading(false);
          });
      }

      // Render media items based on view mode
      function renderMedia() {
        if (state.viewMode === 'grid') {
          renderGridView();
        } else {
          renderListView();
        }

        // Update page info
        if (state.totalItems > 0) {
          const startItem = (state.currentPage - 1) * state.perPage + 1;
          const endItem = Math.min(startItem + state.mediaItems.length - 1, state.totalItems);
          pageInfo.textContent = `Showing ${startItem}-${endItem} of ${state.totalItems} items`;
        } else {
          pageInfo.textContent = `Showing ${state.mediaItems.length} items`;
        }
      }

      // Render grid view
      function renderGridView() {
        mediaGrid.innerHTML = '';

        if (state.mediaItems.length === 0) {
          mediaGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px;">No media items found</div>';
          return;
        }

        state.mediaItems.forEach(item => {
          const mediaItem = document.createElement('div');
          mediaItem.className = 'media-item';

          // Use direct URLs for preview and download
          const sourceUrl = item.source_url;
          let thumbnailUrl = sourceUrl;

          // Try to get thumbnail if available
          if (item.media_details && item.media_details.sizes && item.media_details.sizes.thumbnail) {
            thumbnailUrl = item.media_details.sizes.thumbnail.source_url;
          }

          // Determine media type and preview
          const previewHtml = getPreviewHtml(item, thumbnailUrl);

          // Format file size
          const fileSize = item.media_details && item.media_details.filesize
            ? formatFileSize(item.media_details.filesize)
            : 'Unknown';

          // Format date
          const date = new Date(item.date).toLocaleDateString();

          mediaItem.innerHTML = `
            <div class="media-preview">${previewHtml}</div>
            <div class="media-info">
              <h3 class="media-title">${item.title.rendered || 'Untitled'}</h3>
              <div class="media-meta">
                <span>Type: ${getMimeTypeLabel(item.mime_type)}</span>
                <span>Size: ${fileSize}</span>
                <span>Date: ${date}</span>
              </div>
              <div class="media-actions">
                <button class="preview-btn" data-id="${item.id}">Preview</button>
                <button class="download-btn" data-url="${sourceUrl}">Download</button>
              </div>
            </div>
          `;

          mediaGrid.appendChild(mediaItem);
        });

        // Add event listeners to buttons
        document.querySelectorAll('.preview-btn').forEach(btn => {
          btn.addEventListener('click', () => previewMedia(parseInt(btn.dataset.id)));
        });

        document.querySelectorAll('.download-btn').forEach(btn => {
          btn.addEventListener('click', () => downloadMedia(btn.dataset.url));
        });
      }

      // Render list view
      function renderListView() {
        listBody.innerHTML = '';

        if (state.mediaItems.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="5" style="text-align: center; padding: 30px;">No media items found</td>';
          listBody.appendChild(row);
          return;
        }

        state.mediaItems.forEach(item => {
          const row = document.createElement('tr');

          // Format file size
          const fileSize = item.media_details && item.media_details.filesize
            ? formatFileSize(item.media_details.filesize)
            : 'Unknown';

          // Format date
          const date = new Date(item.date).toLocaleDateString();

          // Direct source URL for download
          const sourceUrl = item.source_url;

          // Get thumbnail for preview
          let thumbnailUrl = sourceUrl;
          if (item.media_details && item.media_details.sizes && item.media_details.sizes.thumbnail) {
            thumbnailUrl = item.media_details.sizes.thumbnail.source_url;
          }

          // Determine preview HTML
          const previewHtml = getPreviewHtml(item, thumbnailUrl);

          const titleCell = document.createElement('td');
          titleCell.innerHTML = `
            <div class="list-preview">${previewHtml}</div>
            <span>${item.title.rendered || 'Untitled'}</span>
          `;

          row.appendChild(titleCell);

          // Add remaining cells
          row.innerHTML += `
            <td>${getMimeTypeLabel(item.mime_type)}</td>
            <td>${date}</td>
            <td>${fileSize}</td>
            <td>
              <button class="preview-btn" data-id="${item.id}">Preview</button>
              <button class="download-btn" data-url="${sourceUrl}">Download</button>
            </td>
          `;

          listBody.appendChild(row);
        });

        // Add event listeners to buttons
        document.querySelectorAll('.preview-btn').forEach(btn => {
          btn.addEventListener('click', () => previewMedia(parseInt(btn.dataset.id)));
        });

        document.querySelectorAll('.download-btn').forEach(btn => {
          btn.addEventListener('click', () => downloadMedia(btn.dataset.url));
        });
      }

      // Preview media in modal
      function previewMedia(id) {
        const item = state.mediaItems.find(item => item.id === id);
        if (!item) return;

        // Direct source URL
        const sourceUrl = item.source_url;

        previewContainer.innerHTML = '';

        if (item.mime_type.startsWith('image/')) {
          previewContainer.innerHTML = `<img src="${sourceUrl}" alt="${item.title.rendered || 'Image'}" />`;
        } else if (item.mime_type.startsWith('video/')) {
          previewContainer.innerHTML = `
            <video controls>
              <source src="${sourceUrl}" type="${item.mime_type}">
              Your browser does not support the video tag.
            </video>
          `;
        } else if (item.mime_type.startsWith('audio/')) {
          previewContainer.innerHTML = `
            <audio controls>
              <source src="${sourceUrl}" type="${item.mime_type}">
              Your browser does not support the audio tag.
            </audio>
          `;
        } else {
          previewContainer.innerHTML = `
            <div style="padding: 30px; background-color: white; text-align: center;">
              <div class="file-icon">📄</div>
              <p>${item.title.rendered || 'File'}</p>
              <p>${item.mime_type}</p>
              <a href="${sourceUrl}" target="_blank" style="display: inline-block; margin-top: 15px; padding: 10px 15px; background-color: #2271b1; color: white; text-decoration: none; border-radius: 4px;">Open File</a>
            </div>
          `;
        }

        previewModal.style.display = 'flex';
      }

      // Close preview modal
      function closePreviewModal() {
        previewModal.style.display = 'none';
        previewContainer.innerHTML = '';
      }

      // Download media
      function downloadMedia(url) {
        // Open the URL in a new tab
        window.open(url, '_blank');
      }

      // Get preview HTML based on mime type
      function getPreviewHtml(item, thumbnailUrl) {
        if (item.mime_type.startsWith('image/')) {
          return `<img src="${thumbnailUrl}" alt="${item.title.rendered || 'Image'}" />`;
        } else if (item.mime_type.startsWith('video/')) {
          return `<div class="file-icon">🎬</div>`;
        } else if (item.mime_type.startsWith('audio/')) {
          return `<div class="file-icon">🔊</div>`;
        } else if (item.mime_type.startsWith('application/pdf')) {
          return `<div class="file-icon">📄</div>`;
        } else {
          return `<div class="file-icon">📁</div>`;
        }
      }

      // Get friendly label for mime type
      function getMimeTypeLabel(mimeType) {
        if (!mimeType) return 'Unknown';

        if (mimeType.startsWith('image/')) {
          return `Image (${mimeType.split('/')[1]})`;
        } else if (mimeType.startsWith('video/')) {
          return `Video (${mimeType.split('/')[1]})`;
        } else if (mimeType.startsWith('audio/')) {
          return `Audio (${mimeType.split('/')[1]})`;
        } else if (mimeType.startsWith('application/')) {
          const format = mimeType.split('/')[1];
          if (format === 'pdf') return 'PDF';
          if (format.includes('word')) return 'Word Document';
          if (format.includes('excel') || format.includes('spreadsheet')) return 'Spreadsheet';
          return `Document (${format})`;
        } else {
          return mimeType;
        }
      }

      // Format file size
      function formatFileSize(bytes) {
        if (!bytes || isNaN(bytes)) return 'Unknown';

        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }

        return `${size.toFixed(1)} ${units[unitIndex]}`;
      }

      // Update search
      function updateSearch() {
        state.search = searchInput.value.trim();
        state.currentPage = 1;
        fetchMedia();
      }

      // Update filters
      function updateFilters() {
        state.mediaType = mediaTypeSelect.value;
        state.sortBy = sortBySelect.value;
        state.sortOrder = sortOrderSelect.value;
        state.currentPage = 1;
        fetchMedia();
      }

      // Switch view mode
      function switchView(mode) {
        state.viewMode = mode;

        if (mode === 'grid') {
          mediaGrid.style.display = 'grid';
          mediaList.style.display = 'none';
          gridViewBtn.classList.add('active-view');
          listViewBtn.classList.remove('active-view');
        } else {
          mediaGrid.style.display = 'none';
          mediaList.style.display = 'table';
          gridViewBtn.classList.remove('active-view');
          listViewBtn.classList.add('active-view');
        }

        renderMedia();
      }

      // Go to previous page
      function goToPreviousPage() {
        if (state.currentPage > 1) {
          state.currentPage--;
          fetchMedia();
        }
      }

      // Go to next page
      function goToNextPage() {
        if (state.currentPage < state.totalPages) {
          state.currentPage++;
          fetchMedia();
        }
      }

      // Update pagination controls
      function updatePagination() {
        prevPageBtn.disabled = state.currentPage <= 1;
        nextPageBtn.disabled = state.currentPage >= state.totalPages;
      }

      // Set loading state
      function setLoading(isLoading) {
        state.isLoading = isLoading;
        loader.style.display = isLoading ? 'inline-block' : 'none';
      }

      // Show error message
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
      }

      // Hide error message
      function hideError() {
        errorMessage.style.display = 'none';
      }

      // Debounce function for search input
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }
    });
  </script>
</body>

</html>